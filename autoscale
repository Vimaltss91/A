#!/bin/bash

namespace="your-namespace"

deployments=$(kubectl get deployments -n "$namespace" -o jsonpath='{.items[*].metadata.name}')

for deployment in $deployments; do
    if [[ $deployment == *"$namespace"* ]]; then
        cat <<EOF | kubectl apply -f -
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: vpa-$deployment
  namespace: $namespace
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: $deployment
  updatePolicy:
    updateMode: "Auto"
EOF
        echo "VPA applied to $deployment"
    else
        echo "Skipping $deployment as it doesn't contain $namespace in the name"
    fi
done
