There are more than 5 jobs in 'QUEUED' status! Currently, there are {queued_count} queued jobs. Please review the jobs, and if any have a higher priority, kindly update the priority accordingly.

0 */2 * * * /usr/bin/python3 /path/to/your/script.py



import mysql.connector
from mysql.connector import Error
import requests
import os

# Slack settings (replace with your Slack bot token and channel ID)
SLACK_TOKEN = os.getenv('SLACK_TOKEN')
SLACK_CHANNEL = "your-channel-id"
SLACK_URL = "https://slack.com/api/chat.postMessage"
MYSQL_HOST = "localhost"  # Replace with your MySQL host
TROUBLESHOOT_LINK = "http://your-troubleshooting-link.com"  # Add your troubleshooting link
DB_NAME = "namespace_management"  # Replace with your database name
TABLE_NAME = "namespace_status"

def send_slack_notification(message):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {SLACK_TOKEN}'
    }
    data = {
        'channel': SLACK_CHANNEL,
        'text': message
    }
    response = requests.post(SLACK_URL, headers=headers, json=data)
    if response.status_code != 200:
        print(f"Failed to send Slack message. Status code: {response.status_code}, Response: {response.text}")

def check_mysql_connection():
    try:
        # Try connecting to MySQL
        connection = mysql.connector.connect(
            host=MYSQL_HOST,
            user='root',
            database=DB_NAME
        )
        if connection.is_connected():
            print("MySQL is up and running")
            check_queued_status(connection)
            connection.close()
    except Error as e:
        print(f"MySQL is not reachable: {e}")
        send_slack_notification(f"@here :exclamation: MySQL host '{MYSQL_HOST}' is currently down! Immediate action is required! "
                                f"Please refer to the configuration page for troubleshooting: {TROUBLESHOOT_LINK}")

def check_queued_status(connection):
    try:
        cursor = connection.cursor()
        # SQL query to count rows with status = 'QUEUED'
        query = f"SELECT COUNT(*) FROM {TABLE_NAME} WHERE status = 'QUEUED'"
        cursor.execute(query)
        result = cursor.fetchone()
        queued_count = result[0] if result else 0
        print(f"Queued count: {queued_count}")

        # Check if the count is more than 5 and send a Slack notification
        if queued_count > 5:
            message = (f"@here :exclamation: There are more than 5 jobs in 'QUEUED' status! "
                       f"Currently, there are {queued_count} queued jobs in the '{TABLE_NAME}' table. "
                       f"Immediate action may be required.")
            send_slack_notification(message)
    except Error as e:
        print(f"Error while querying the database: {e}")
        send_slack_notification(f"@here :exclamation: Error while checking 'QUEUED' status in MySQL database: {e}")

if __name__ == "__main__":
    check_mysql_connection()
